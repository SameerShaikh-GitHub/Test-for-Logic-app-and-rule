{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/f87f1ca8-45bd-4bbb-9cfd-adeba2b542f9')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/f87f1ca8-45bd-4bbb-9cfd-adeba2b542f9')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-09-01-preview",
            "properties": {
                "displayName": "SHQ - Custom Log4j Vulnerability",
                "description": "",
                "severity": "High",
                "enabled": false,
                "query": "let IPList = dynamic([\"185.220.101.57\", \"185.220.102.24\", \"162.142.125.44\", \"162.142.125.58\", \"188.166.48.55\", \"188.166.92.228\", \"188.166.122.43\", \"193.189.100.19\", \"167.248.133.58\", \"193.218.118.18\", \"167.94.138.41\", \"193.218.118.18\", \"167.94.138.44\", \"212.193.57.225\", \"18.27.197.252\", \"23.129.64.131\", \"23.129.64.141\", \"23.129.64.146\", \"23.129.64.148\", \"45.12.134.108\", \"45.155.205.233\", \"46.166.139.111\", \"46.182.21.248\", \"51.15.43.205I\", \"51.255.106.85\", \"54.173.99.121\", \"62.102.148.69\", \"72.223.168.73\", \"81.17.18.60In\", \"104.244.72.115\", \"104.244.74.57\", \"104.244.74.211\", \"104.244.76.170\", \"107.189.1.160\", \"107.189.1.178\", \"107.189.12.135\", \"107.189.14.98\", \"122.161.50.23\", \"171.25.193.20\", \"171.25.193.25\", \"171.25.193.77\", \"171.25.193.78\", \"178.62.79.49I\", \"181.214.39.2I\", \"185.38.175.132\", \"185.83.214.69\", \"185.100.87.41\", \"185.100.87.202\", \"185.107.47.171\", \"185.129.61.1I\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.24\", \"185.220.100.25\", \"185.220.100.25\", \"185.220.100.25\", \"185.220.100.25\", \"185.220.101.33\", \"185.220.101.34\", \"185.220.101.35\", \"185.220.101.36\", \"185.220.101.42\", \"185.220.101.43\", \"185.220.101.45\", \"185.220.101.46\", \"185.220.101.49\", \"185.220.101.54\", \"185.220.101.55\", \"185.220.101.56\", \"185.220.101.61\", \"185.220.101.12\", \"185.220.101.13\", \"185.220.101.13\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.14\", \"185.220.101.15\", \"185.220.101.15\", \"185.220.101.15\", \"185.220.101.15\", \"185.220.101.16\", \"185.220.101.16\", \"185.220.101.16\", \"185.220.101.16\", \"185.220.101.17\", \"185.220.101.17\", \"185.220.101.17\", \"185.220.101.17\", \"185.220.101.18\", \"185.220.101.18\", \"185.220.101.18\", \"185.220.101.18\", \"185.220.101.18\", \"185.220.101.19\", \"185.220.102.8\", \"185.220.102.24\", \"193.31.24.154\", \"193.189.100.20\", \"193.218.118.23\", \"194.48.199.78\", \"195.176.3.24I\", \"195.254.135.76\", \"198.98.51.189\", \"199.195.250.77\", \"204.8.156.142\", \"205.185.117.14\", \"209.127.17.242\", \"209.141.41.103\", \"45.153.160.131\", \"45.153.160.138\", \"62.76.41.46In\", \"68.183.44.143\", \"68.183.198.247\", \"88.80.20.86In\", \"109.70.100.34\", \"109.237.96.124\", \"116.24.67.213\", \"134.122.34.28\", \"137.184.102.82\", \"137.184.106.11\", \"142.93.34.250\", \"143.198.32.72\", \"143.198.45.117\", \"147.182.167.16\", \"147.182.169.25\", \"147.182.219.9\", \"151.115.60.113\", \"159.65.58.66I\", \"159.65.155.208\", \"164.90.199.216\", \"167.99.164.201\", \"167.99.172.58\", \"167.99.172.213\", \"185.220.100.24\", \"185.220.101.37\", \"185.220.101.41\", \"185.220.101.57\", \"185.220.101.13\", \"185.220.101.14\", \"185.220.101.15\", \"185.220.101.16\", \"185.220.101.17\", \"185.220.101.18\", \"185.220.102.24\", \"188.166.48.55\", \"188.166.92.228\", \"188.166.122.43\", \"193.189.100.19\", \"193.218.118.18\", \"195.19.192.26\", \"212.193.57.225\"]);\r\n(union isfuzzy=true\r\n(CommonSecurityLog\r\n| where isnotempty(SourceIP) or isnotempty(DestinationIP)\r\n| where SourceIP in (IPList) or DestinationIP in (IPList) or Message has_any (IPList)\r\n| extend IPMatch = case(SourceIP in (IPList), \"SourceIP\", DestinationIP in (IPList), \"DestinationIP\", \"Message\")\r\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by SourceIP, DestinationIP, DeviceProduct, DeviceAction, Message, Protocol, SourcePort, DestinationPort, DeviceAddress, DeviceName, IPMatch\r\n| extend timestamp = StartTimeUtc, IPCustomEntity = case(IPMatch == \"SourceIP\", SourceIP, IPMatch == \"DestinationIP\", DestinationIP, \"IP in Message Field\")\r\n),\r\n(OfficeActivity\r\n|extend SourceIPAddress = ClientIP, Account = UserId\r\n| where SourceIPAddress in (IPList)\r\n| extend timestamp = TimeGenerated , IPCustomEntity = SourceIPAddress , AccountCustomEntity = Account\r\n),\r\n(DnsEvents\r\n| extend DestinationIPAddress = IPAddresses, Host = Computer\r\n| where DestinationIPAddress has_any (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host\r\n),\r\n(imDns (response_has_any_prefix=IPList)\r\n| extend DestinationIPAddress = ResponseName, Host = SrcIpAddr\r\n| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host\r\n),\r\n(VMConnection\r\n| where isnotempty(SourceIp) or isnotempty(DestinationIp)\r\n| where SourceIp in (IPList) or DestinationIp in (IPList)\r\n| extend IPMatch = case( SourceIp in (IPList), \"SourceIP\", DestinationIp in (IPList), \"DestinationIP\", \"None\")\r\n| extend timestamp = TimeGenerated , IPCustomEntity = case(IPMatch == \"SourceIP\", SourceIp, IPMatch == \"DestinationIP\", DestinationIp, \"None\"), Host = Computer\r\n),\r\n(Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID == 3\r\n| extend EvData = parse_xml(EventData)\r\n| extend EventDetail = EvData.DataItem.EventData.Data\r\n| extend SourceIP = EventDetail.[9].[\"#text\"], DestinationIP = EventDetail.[14].[\"#text\"]\r\n| where SourceIP in (IPList) or DestinationIP in (IPList)\r\n| extend IPMatch = case( SourceIP in (IPList), \"SourceIP\", DestinationIP in (IPList), \"DestinationIP\", \"None\")\r\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserName, HostCustomEntity = Computer , IPCustomEntity = case(IPMatch == \"SourceIP\", SourceIP, IPMatch == \"DestinationIP\", DestinationIP, \"None\")\r\n),\r\n(WireData\r\n| where isnotempty(RemoteIP)\r\n| where RemoteIP in (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = Computer\r\n),\r\n(SigninLogs\r\n| where isnotempty(IPAddress)\r\n| where IPAddress in (IPList)\r\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress\r\n),\r\n(AADNonInteractiveUserSignInLogs\r\n| where isnotempty(IPAddress)\r\n| where IPAddress in (IPList)\r\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress\r\n),\r\n(W3CIISLog\r\n| where isnotempty(cIP)\r\n| where cIP in (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = cIP, HostCustomEntity = Computer, AccountCustomEntity = csUserName\r\n),\r\n(AzureActivity\r\n| where isnotempty(CallerIpAddress)\r\n| where CallerIpAddress in (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = CallerIpAddress, AccountCustomEntity = Caller\r\n),\r\n(\r\nAWSCloudTrail\r\n| where isnotempty(SourceIpAddress)\r\n| where SourceIpAddress in (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = SourceIpAddress, AccountCustomEntity = UserIdentityUserName\r\n),\r\n(\r\nDeviceNetworkEvents\r\n| where isnotempty(RemoteIP)\r\n| where RemoteIP in (IPList)\r\n| extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = DeviceName\r\n),\r\n(\r\nAzureDiagnostics\r\n| where ResourceType == \"AZUREFIREWALLS\"\r\n| where Category == \"AzureFirewallApplicationRule\"\r\n| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action\r\n| where isnotempty(DestinationHost)\r\n| where DestinationHost has_any (IPList)\r\n| extend DestinationIP = DestinationHost\r\n| extend IPCustomEntity = SourceHost\r\n),\r\n(\r\nAzureDiagnostics\r\n| where ResourceType == \"AZUREFIREWALLS\"\r\n| where Category == \"AzureFirewallNetworkRule\"\r\n| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action\r\n| where isnotempty(DestinationHost)\r\n| where DestinationHost has_any (IPList)\r\n| extend DestinationIP = DestinationHost\r\n| extend IPCustomEntity = SourceHost\r\n)\r\n)",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "tactics": [
                    "Reconnaissance",
                    "InitialAccess",
                    "Execution"
                ],
                "techniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "AlertPerResult"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "AccountCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "HostCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "IP",
                        "fieldMappings": [
                            {
                                "identifier": "Address",
                                "columnName": "IPCustomEntity"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null
            }
        }
    ]
}